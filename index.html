<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap" rel="stylesheet">
    <!-- link css -->
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="head">
      <h1>かんばんボード</h1>
    </div>
    <div class="board">
      <div class="column" id="todo">
        <h2>やるべきこと</h2>
        <hr />
        <div class="tasks-in-btn">
          <input
            type="text"
            id="taskInput"
            class="task-input"
            placeholder="タスクを入力してください..."
            ondrop="handleDropOnInput(event)"
            ondragover="event.preventDefault()"
          />
          <button class="add-task-btn" onclick="addTask('todo')">
            タスクの追加
          </button>
        </div>
        <div class="task-container"></div>
      </div>
      <div class="column" 
        id="in-progress"
        ondrop="drop(event, 'in-progress')"
        ondragover="allowDrop(event)">
        <h2>進行中</h2>
        <hr />
        <div
          class="task-container"

        ></div>
      </div>
      <div
        class="column"
        id="done"
        ondrop="drop(event, 'done')"
        ondragover="allowDrop(event)"
      >
        <h2>完了した!</h2>
        <hr />
        <div class="task-container"></div>
      </div>
    </div>
    <script>    
        console.log("This is my kanban board")

        // GET ITEMS FROM LOCALSTORAGE
        let tasks = JSON.parse(localStorage.getItem('tasks'))|| []

        tasks = tasks.filter(Boolean);  // removes nulls 

        document.addEventListener("DOMContentLoaded", renderTasks);

        function handleDropOnInput(event) {
            event.preventDefault(); // block the drop
            alert("⚠️ この欄には直接ドロップできません。\nテキストを入力してください。");
        }

        function renderTasks() {
            // localStorage.clear();
            const columns = ["todo", "in-progress", "done"];
            // console.log('tasks = ',tasks)
            columns.forEach((columnId) => {
                const column = document.getElementById(columnId);
                console.log("column =", column);
                // first, clear the tasks from the board -stop adding the same tasks
                column.querySelector(".task-container").innerHTML = "";

                // then we will loop through the tasks and add them to the board
                tasks.forEach((task) => {
                    console.log("task =", task);
                    if (task.status === columnId) {
                    const taskElement = createTaskElement(task.content, task.id);
                    column.querySelector(".task-container").appendChild(taskElement);
                    }
                });
            });
        }
        // Creates a Task Element
        function createTaskElement(content,id){
            const taskId = id
            const task = document.createElement('div')
            task.id = taskId
            task.className = 'task'
            task.draggable = true
            task.innerHTML = `
            ${content}
            <span class="delete-btn" onclick="deleteTask('${taskId}') ">
                消す
            </span>
            `;
            task.addEventListener('dragstart',drag)
            return task;
            
        }
        //  add task function
        // - { id: "task-" + Date.now(), content: taskContent, status: columnId }
        function addTask(columnId) {
            const taskInput = document.getElementById("taskInput");
            const taskContent = taskInput.value.trim();
            if (taskContent !== "") {
            const newTask = {
                id: `task-${Date.now()}`,
                content: taskContent,
                status: columnId,
            };
            tasks.push(newTask);
            // update localStorage
            updateLocalStorage();
            renderTasks();
            taskInput.value = "";
            }
        }

        // Delete Task

        function deleteTask(taskId) {

            // console.log("taskId =", taskId);

            // remove with TaskId with filter (for loop too bulky)

            tasks = tasks.filter((task) => task.id !== taskId);

            //update storage

            updateLocalStorage();

            // render again
            renderTasks();
        }
        
        function updateLocalStorage() {
            localStorage.setItem("tasks", JSON.stringify(tasks));
        }

        function allowDrop(event){

            //prevent default actions

            event.preventDefault();
        }

        function drag(event){

            event.dataTransfer.setData('text/plain', event.target.id);
        }

        function drop(event,columnId){
            event.preventDefault();
            console.log("changed task status", columnId);
            const data = event.dataTransfer.getData('text/plain');
            const draggedElement = document.getElementById(data);
            if(draggedElement){
                const taskStatus = columnId;
                updateTaskStatus(data, taskStatus);
                // event.target.querySelector('.task-container').appendChild(draggedElement)
                // Always refer to the column, not the inner target
                const column = document.getElementById(taskStatus);
                column.querySelector(".task-container").appendChild(draggedElement);
            }
        }

        function updateTaskStatus(taskId,newStatus){

            console.log("new status = ", newStatus)
            tasks = tasks.map( (task) =>{
                if(task.id == taskId){
                     return{
                        ...task,
                        status: newStatus
                     };
                }
            return task;  // <--- keep it in array instead of undefined
            }
            );
            updateLocalStorage();

        }

    </script>
  </body>
</html>
